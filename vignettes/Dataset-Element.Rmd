---
title: "Dataset Element"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dataset-Element}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
The following libraries are needed to create a working EML document. 
```{r, message = FALSE}
library(EDIutils)
library(tidyverse)
library(readxl)
library(EML)
```

# Dataset Element 
This document explains how to add multiple datasets to one EML document and how to 
add non tabular data to an EML document. 

## Multiple datsets for one data package
## Diffrent types of datasets 
```{r, warning=F, include=False}
excel_path <- system.file("extdata", "Hannon-Example", "example-metadata.xlsx", 
                          package = "EDIutils", mustWork = TRUE)

sheets <- readxl::excel_sheets(excel_path)
metadata_sheets <- lapply(sheets, function(x) readxl::read_excel(excel_path, sheet = x))
names(metadata_sheets) <- sheets

abstract_docx <- system.file("extdata", "Hannon-Example", "hannon_example_abstract.docx", 
                             package = "EDIutils", mustWork = TRUE)

methods_docx <- system.file("extdata", "Hannon-Example", "hannon_example_methods.docx", 
                            package = "EDIutils", mustWork = TRUE)
edi_number = "edi.687.1"
```

```{r, eval = FALSE}
excel_path <- "data-raw/Hannon-Example/example-metadata.xlsx"

sheets <- readxl::excel_sheets(excel_path)
metadata <- lapply(sheets, function(x) readxl::read_excel(excel_path, sheet = x))
names(metadata) <- sheets

abstract_docx <- "data-raw/Hannon-Example/hannon_example_abstract.docx"

methods_docx <- "data-raw/Hannon-Example/hannon_example_methods.docx"

dataset_file <- "data-raw/Hannon-Example/hannon_example_physical_data.csv"

dataset_file_name <- "hannon_example_physical_data.csv"

edi_number <- "edi.678.1"
```

The files added below: 

* One or more data files (preferably csv if tabular data) 

In this example we included two datasets by creating a nested list of the datasets. 

Each named dataset list includes:

* A `datatable` element which is the file path to the datatable
* A `datatable_name`
* An `attribute` section that reads in the attribute table for the dataset 
* The `code` section that reads in the attribute codes for the dataset
* (Optional) `dataset_methods` section that reads file path to dataset specific methods
* (Optional) `additional_information` If additional information is pertinent to the entry please add it as a string description. 

In this example there are no dataset specific methods or additional information so those fields are NULL. 

To add more than two datasets please follow the same structure adding additional 
named lists within the dataset files list. 
```{r}
dataset_files <- list("snorkel data" = list(datatable = system.file("extdata", "Hannon-Example", 
                                                                    "hannon_example_physical_data.csv",
                                                        package = "EDIutils", mustWork = TRUE),
                                            datatable_name = "hannon_example_snorkel_data.csv",
                                            attribute = metadata_sheets$attribute,
                                            code = metadata_sheets$code_definitions,
                                            dataset_methods = NULL,
                                            additional_info = NULL), 
                      "predator data" = list(datatable = system.file("extdata", "Hannon-Example", 
                                                                     "hannon_example_physical_data.csv",
                                                         package = "EDIutils", mustWork = TRUE),
                                             datatable_name = "hannon_example_predator_data.csv",
                                             attribute = metadata_sheets$attribute,
                                             code = metadata_sheets$code_definitions,
                                             dataset_methods = NULL,
                                             additional_info = NULL))
```

### Data Table 
Next, we need to create the data table. The data table element includes`physical`, `attribute_list`, 
and potentially additional information for Spatial Data. These sections are all lists 
which must be created first, appended to a dataTable, and then appended to 
the `parent_element`.

#### Physical 
The physical element can be created first using the `add_physical` function. 
This will append information on the actual physical information of the data. 
The file path of the data can be added to the "example-metadata.xlsx" excel file 
and all parameters will be appended, gathering the csv's unique size and 
authentication, as well as providing the default physical values of a csv. 

```{r}
physical <- add_physical(file_path = dataset_file)
```

If you wish to provide alternative information than the defaults of a csv, you must do
so manually in Rstudio using the `add_physical` function fully. It is not recommended 
that you do so, however, as the default values present represent the best practices 
in most cases. 

#### Attribute List 
Next, we will need to append an attribute list to the data table. We will be able 
to use the `add_attribute` function to do so. Please make sure you review what 
type of attribute you are providing and what inputs are necessary. These values 
can then be inputted into the "attribute" tab in the "example-metadata.xlsx" excel file. If you
are using a "nominal" or "ordinal" attribute which is "enumerated", (it has a specific 
code definition), please also use the tab "code_definitions". Provide each
unique code and definition, with its `attribute_name` aligning to that which is in the
"attribute" tab. An example is present currently to help better showcase this. Every single 
column in the dataTable must have a described attribute to match EDI congruence checker. 

```{r}
attribute_table <- metadata$attribute
codes <- metadata$code_definitions
attribute_list <- list()

code_helper <- function(code, definitions) {
  codeDefinition <- list(code = code, definition = definitions)
}
attributes_and_codes <- function(attribute_name, attribute_definition, storage_type, 
                                 measurement_scale, domain, type, units, unit_precision, 
                                 number_type, date_time_format, date_time_precision, minimum, maximum, 
                                 attribute_label){
  if (domain %in% "enumerated") { 
    definition <- list()
    current_codes <- codes[codes$attribute_name == attribute_name, ]
    definition$codeDefinition <- purrr::pmap(current_codes %>% select(-attribute_name), code_helper) 
  } else {
    definition = attribute_definition
  }
  new_attribute <- add_attribute(attribute_name = attribute_name, attribute_definition = attribute_definition,
                                 storage_type = storage_type, measurement_scale = measurement_scale, 
                                 domain = domain, definition = definition, type = type, units = units, 
                                 unit_precision = unit_precision, number_type = number_type, 
                                 date_time_format = date_time_format, date_time_precision = date_time_precision, 
                                 minimum = minimum, maximum = maximum, attribute_label = attribute_label)
}
attribute_list$attribute <- purrr::pmap(attribute_table, attributes_and_codes) 
```

#### Putting the Data Table Together
Now that we have the `attribute_list` and `physical` information, we 
can compose the data table, which is the last element we need to create our 
working EML file.  

```{r}

data_tables <- list(dataTable =  list(entityName = dataset_file_name,
                                      entityDescription = metadata$dataset$name,
                                      physical = physical,
                                      attributeList = attribute_list))
```

If you have 
```{r}

parent_element$spatialVector <- list(entityName = dataset_file,
                                     entityDescription = metadata$dataset$name,
                                     physical = physical,
                                     attributeList = attribute_list,
                                     geometry = metadata$dataset$geometry)
```


```{r}
## TODO RASTER DATA 
```
