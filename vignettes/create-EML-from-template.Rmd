---
title: "Create EML from Template"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{create-EML-from-template}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(EMLaide)
library(tidyverse)
library(EDIutils)
library(readxl)
library(EML)
```

## Ecological Metadata Language(EML) Schema Outline 

We use the EML package to generate the EML document based on our metadata inputs. The EML package `write_eml()` function takes in a nested list and formats the list into an EML document. 
To create valid EML the nested list must:

* Contain all required EML fields
* nest all fields under the correct sub sections

We have two main sections within our EML document:

* Access - The [Access Section](https://eml.ecoinformatics.org/schema/eml_xsd.html#eml_access) defines the access for the entire resource (entire EML document)
* Dataset - The [Dataset Resource](https://eml.ecoinformatics.org/schema/eml_xsd.html#eml_dataset) contains the descriptive metadata information on a data set. A data set can contain one or more data entities. A data entity is a tabular data table or a vector or raster image. 

The Dataset element contains all of the additional metadata information. The Dataset element is composed of nested lists. Some information is at the top level and is applicable to all elements in the Dataset but other information is nested within subsections and is metadata specific to that subsection. 

For a more in depth description of EML please see [EML Specification.](https://eml.ecoinformatics.org/)

In this document, we can quickly create an EML file which has the opportunity to 
append the following elements. For more detailed instructions on a specific section 
please see section specific articles. 

```yaml
- eml 
  -access
  -dataset
    - creator
    - contact
    - associated parties
    - title  
    - abstract 
    - keyword set  
    - license 
    - methods 
    - maintenance 
    - project
    - coverage 
    - data table 
```

## Our Example UPDATE THIS TEXT
We will use the data provided by [WHO] to show an example of how to compile
metadata in a valid EML document that can be uploaded to the EDI data portal website. 
To follow along with this example please download the [UPDATE zip folder](https://cvpia-data-stewardship.s3-us-west-1.amazonaws.com/UPDATE.zip). 

### Required Files 
Four files must be uploaded to make a complete EML document. To follow along with this example please load the following files from the `UPDATE` folder into your environment. 

* An excel spreadsheet containing the majority of the metadata
* A word document containing the abstract text 
* A word document containing the methods text 
* A file that contains the data (preferably csv if tabular data) and the name of the file 

```{r, include = FALSE}
excel_path <- system.file("extdata", "Hannon-Example", "snorkel-index-example-metadata.xlsx", 
                          package = "EMLaide", mustWork = TRUE) # UPDATE
sheets <- readxl::excel_sheets(excel_path)
metadata <- purrr::map(sheets, function(x) readxl::read_excel(excel_path, sheet = x))
names(metadata) <- sheets

abstract_docx <- system.file("extdata", "Hannon-Example", "snorkel-index-example-abstract.docx", 
                             package = "EMLaide", mustWork = TRUE) #UPDATE

methods_docx <- system.file("extdata", "Hannon-Example", "snorkel-index-example-methods.docx", 
                            package = "EMLaide", mustWork = TRUE)  #UPDATE

dataset_file <- system.file("extdata", "Hannon-Example", "snorkel-index-example-data.csv",
                               package = "EMLaide", mustWork = TRUE)  #UPDATE

dataset_file_name <- "snorkel_index_example_data.csv"  #UPDATE
```

```{r, eval = FALSE}
excel_path <- "Hannon-Example/snorkel-index-example-metadata.xlsx"

sheets <- readxl::excel_sheets(excel_path)
metadata <- lapply(sheets, function(x) readxl::read_excel(excel_path, sheet = x))
names(metadata) <- sheets

abstract_docx <- "Hannon-Example/snorkel-index-example-abstract.docx"

methods_docx <- "Hannon-Example/snorkel-index-hannon-example-methods.docx"

dataset_file <- "Hannon-Example/snorkel-index-example-data.csv"

dataset_file_name <- "snorkel-index-example-data.csv" #UPDATE
```


### EDI Number

In addition to these four files a entity description and an EDI number must be defined. 
The EDI number should be a unique data package identifier. You can reserve this 
data package identifier number on the [EDI data repository under tools.](https://portal.edirepository.org/nis/reservations.jsp)
```{r}
edi_number <- "edi.###.#" #UPDATE MAKE FAKE
```


## Multiple Datasets
Describe attribute stuff and need for data hosted online
This dataframe is input to `add_datatables` and explain what it does for each record
```{r}
# Add all datatables and associated metadata in a datatable_metadata tibble to be used by the add_datatable() function
datatable_metadata <- 
  dplyr::tibble(filepath = c("data/enclosure-study-growth-rate-data.csv",
                             "data/enclosure-study-gut-contents-data.csv",
                             "data/microhabitat-use-data-2018-2020.csv",
                             "data/seining-weight-lengths-2018-2020.csv",
                             "data/snorkel-index-data-2015-2020.csv"),  
                attribute_info = paste0("data-raw/mandy-salmanid-habitat-monitoring/",
                                        c("Enclosure Study - Growth Rates/enclosure-study-growth-rates-metadata.xlsx",
                                          "Enclosure Study - Gut Contents/enclosure-study-gut-contents-metadata.xlsx",
                                          "Microhabitat Use Data/microhabitat-use-metadata.xlsx",
                                          "Seining Data/seining-weight-length-metadata.xlsx",
                                          "Snorkel Index Data/snorkel-index-metadata.xlsx")),
                datatable_description = c("Growth Rates - Enclosure Study",
                                          "Gut Contents - Enclosure Study",
                                          "Microhabitat Data",
                                          "Seining Weight Lengths Data",
                                          "Snorkel Survey Data"),
                datatable_url = paste0("https://raw.githubusercontent.com/FlowWest/edi.749.1/main/data/",
                                       c("enclosure-study-growth-rate-data.csv",
                                         "enclosure-study-gut-contents-data.csv",
                                         "microhabitat-use-data-2018-2020.csv",
                                         "seining-weight-lengths-2018-2020.csv",
                                         "snorkel-index-data-2015-2020.csv")))

View(datatable_metadata)
```

## Create Dataset Element

Beginning with an empty list, each function call appends and an EML element as a named list.

The `add_[blank]` functions are wrappers on `create_[blank]` function to enable a `%>%` workflow.

For details on appropriate inputs to the functions see documentation at `?add_[blank]`.

```{r}

# save cleaned data to `data/`
#-------------------------------------------------------------------------------
# files and parameters to enter directly into the R script
excel_path <- "data-raw/mandy-salmanid-habitat-monitoring/Enclosure Study - Growth Rates/enclosure-study-growth-rates-metadata.xlsx"
sheets <- readxl::excel_sheets(excel_path)
metadata <- lapply(sheets, function(x) readxl::read_excel(excel_path, sheet = x))
names(metadata) <- sheets

abstract_docx <- "data-raw/mandy-salmanid-habitat-monitoring/Enclosure Study - Growth Rates/enclosure-study-growth-rates-abstract.docx"
methods_docx <- "data-raw/mandy-salmanid-habitat-monitoring/methods.md"
```

show and describe metadata$
for template items with multiple rows the `add_[blank]` map through each row and create blah


```{r}
# Create dataset list and pipe on metadata elements 
dataset <- list() %>%
  add_pub_date() %>% 
  add_title(metadata$title) %>%
  add_personnel(metadata$personnel) %>%
  add_keyword_set(metadata$keyword_set) %>%
  add_abstract(abstract_docx) %>%
  add_license(metadata$license) %>%
  add_method(methods_docx) %>%
  add_maintenance(metadata$maintenance) %>%
  add_project(metadata$funding) %>%
  add_coverage(metadata$coverage, metadata$taxonomic_coverage) %>%
  add_datatable(datatable_metadata)
```

## Handle Custom Units

When units aren't standard need to formally define.

```{r}
# Create custom units to add to the additional metadata section of EML 
custom_units <- data.frame(id = c("fishPerEnclosure", "thermal unit", "day", "fishPerSchool"),
                           unitType = c("density", "temperature", "dimensionless", "density"),
                           parentSI = c(NA, NA, NA, NA),
                           multiplierToSI = c(NA, NA, NA, NA),
                           description = c("Fish density in the enclosure, number of fish in total enclosure space",
                                           "thermal unit of energy given off of fish",
                                           "count of number of days that go by",
                                           "Number of fish counted per school"))

unitList <- EML::set_unitList(custom_units)
```

## Combine EML Elements and Build Document 

The `add_access` adds an access section at the beginning of our EML document. The 
`add_access` default is public principal with a read permission. 

The `dataset` list from above contains ....

Using `write_eml` and `eml_validate` functions from the `EML` package to convert and check validity.


```{r}
# Add dataset and additiobal elements of eml to eml list
eml <- list(packageId = "edi.749.1",
            system = "EDI",
            access = add_access(),
            dataset = dataset,
            additionalMetadata = list(metadata = list(unitList = unitList)))

# Write and validate EML
EML::write_eml(eml, "edi.749.1.xml")
EML::eml_validate("edi.749.1.xml")

```
